# test10

Отказоустойчивая система, с автоматизацией установки и настройки.
Состоять из следующих элементов:
- балансировщик нода 1 (nginx, pacemaker, corosync, crmsh)
- балансировщик нода 2 (nginx, pacemaker, corosync, crmsh)
- бэкэнд нода 1 (apsche2)
- бэкэнд нода 2 (apsche2)
- сервер автоматизации (ansible - по заданию требуется вручную установить ansible)


После скачивания заходим в папку Docker и выполняем для раскатки докер контейнеров:

docker compose -f docker-compose.yml up -d

Должны создасться контейнеры с данными именами:
балансировщик нода 1 -  web1     - 172.16.0.2
балансировщик нода 2 -  web2     - 172.16.0.3
бэкэнд нода 1 -         bec1     - 172.16.0.4
бэкэнд нода 2 -         bec2     - 172.16.0.5
сервер автоматизации -  ansible  - 172.16.0.6

vip адрес - 172.16.0.10

Копируем наше содержимое папки ansible с нашими 3 плейбуками в контейнер с именем ansible:

docker cp ansible/ ansible:/

1. playbook установки балансировщиков и их настройки.
2. playbook установки и настройки кластеризации балансировщиков.
3. playbook установки и настройки бэкенда.

после чего входим в конйтенер ansible "Для входа логин:пароль используем root:root"

docker exec -ti ansible bash

По заданию на нём не установлен ansible, начинаем установку:

sudo apt-get install ansible -y
sudo apt install sshpass

В корне контейнера после копирования должна быть папка ansible, входим в неё
В папке находится 3 каталога( 1nginx, 2pacemaker и 3apache) входим сначала в 1 и выполняем команду запуск плейбука "хочу отметить плейбук у меня с расширением .yaml"
ansible-playbook playbook.yaml

Так же выполняем команду "ansible-playbook playbook.yaml" в папке 2pacemaker и 3apache

После того как все 3 плейбука отработали, можно для начала проверить что отрабатываеют наши балансировщики
curl 172.16.0.2
curl 172.16.0.3
должно высветиться сообщение <h1>Это backend1"</h1> или <h1>Это backend2"</h1>

потом можно проверить наши бекенды
curl 172.16.0.4 #отобразится сообщение <h1>Это backend1"</h1>
curl 172.16.0.5 #отобразится сообщение <h1>Это backend2"</h1>

curl 172.16.0.10 #отобразится сообщение <h1>Это backend1"</h1 или <h1>Это backend2"</h1>

Выходим из контейнера ansible
exit


Проверим состояние узла и состояния кластера через web1 или web2 контейнер и увидим, что всё работает
docker exec web1 crm status

Теперь проведём тестирование активного-пассивного кластера или отказоустойчивости.

Можно или остановить контейнер web1 или web2 или послать команаду стоп на одном из узлов"в самом контейнере wem1 или wem2" crm cluster stop
Стопанем web1 контейнер
docker stop web1

удостоверимся что он остановлен:
docker ps -a

После чего проверим что 1 узел у нас перешел в офлайн "web1" а ресурс с vip переключился на web2
docker exec web2 crm status

Проверяем через curl 172.16.0.10 и видим что балансировщик, ресурс и бекенд продолжает отрабатывать запросы

Можно остановить контейнер бек1 и тогда на curl будут присылаться только сообщения <h1>Это backend2"</h1> так как работает только 2ой бекенд